<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Lyrics</title>
	<script type="text/javascript" src="../js/lyrics.js"></script>
	<link rel="stylesheet" href="../css/lyricer.css">
	<link href="https://fonts.googleapis.com/css?family=M+PLUS+1p" rel="stylesheet">
</head>
<body style="margin: 0;">
    <img style="" id="backgroundImage" alt="Background Image"></img>
	<div style="width: 100%; height: 100%; opacity: 0.8;  z-index: 1; background-color: rgba(0, 0, 0, 0.5); position: absolute;"></div>
	<div id="lyricer">
	</div>
	<script type="text/javascript">
	const { ipcRenderer } = require('electron');
	

	function changeStylesheetRule(stylesheet, selector, property, value) {
	selector = selector.toLowerCase();
	property = property.toLowerCase();
	value = value.toLowerCase();

	for(var i = 0; i < stylesheet.cssRules.length; i++) {
		var rule = stylesheet.cssRules[i];
		if(rule.selectorText === selector) {
			rule.style[property] = value;
			return;
		}
	}
  
	stylesheet.insertRule(selector + " { " + property + ": " + value + "; }", 0);
    }

	var text = "";
	var lrcfile = "";
	var lrc = new Lyricer();
    var token = '';
	function revisedRandId() {
     return Math.random().toString(36).replace(/[^a-z]+/g, '').substr(2, 10);
    }
	function u(track, artist, lang) {
		try{
		// var artist = encodeURIComponent('joji');
        // var track =  encodeURIComponent('slow danicng in the dark');
		var language_code = lang;

		var usertoken = encodeURIComponent(token);
		var url  = "https://apic-desktop.musixmatch.com/ws/1.1/macro.subtitles.get?format=json&namespace=lyrics_richsynched&subtitle_format=lrc&q_artist="+artist+"&q_track="+track+"&usertoken="+usertoken+"&app_id=web-desktop-app-v1.0&t="+revisedRandId();
		var req = new XMLHttpRequest();  
        req.overrideMimeType("application/json");
        req.open('GET', url, true);
		req.setRequestHeader("authority", "apic-desktop.musixmatch.com");
        req.onload  = function() {	
        var jsonResponse = JSON.parse(this.responseText);
		console.log(jsonResponse);
		var status1 = jsonResponse["message"]["header"]["status_code"] ;
		if (status1 == 200){     
        var id = '';
		try{
	    if (jsonResponse["message"]["body"]["macro_calls"]["matcher.track.get"]["message"]["header"]["status_code"] == 200){
		id = jsonResponse["message"]["body"]["macro_calls"]["matcher.track.get"]["message"]["body"]["track"]["track_id"] ?? '';
		lrcfile = jsonResponse["message"]["body"]["macro_calls"]["track.subtitles.get"]["message"]["body"]["subtitle_list"][0]["subtitle"]["subtitle_body"];}
		if (lrcfile == "" || id == ''){
			   ipcRenderer.send('LyricsMXMFailed','');
		} else{
			lrcfile = lrcfile.concat("\r\n"); 
			var timearr = lrcfile.match(/\[([0-9]+):([0-9.]+)]/g);
			timearr.unshift('[00:00.000]');
			
            for (i = 0; i < timearr.length -1 ; i++){
				var rawTime = timearr[i+1].match(/(\d+:)?(\d+:)?(\d+)(\.\d+)?/);
                var hours = (rawTime[2] != null) ? (rawTime[1].replace(":", "")) : "0";
                var minutes =
                    (rawTime[2] != null) ? (hours * 60 + rawTime[2].replace(":", "") * 1 + ":") : ((rawTime[1] != null) ? rawTime[1] : "00:")
                ;
                var seconds = (rawTime[3] != null) ? (rawTime[3]) : "00";
                var milliseconds = (rawTime[4] != null) ? (rawTime[4]) : ".000";
                var lrcTime = minutes + seconds + milliseconds;
                var rawTime2 = timearr[i].match(/(\d+:)?(\d+:)?(\d+)(\.\d+)?/);
                var hours2 = (rawTime2[2] != null) ? (rawTime2[1].replace(":", "")) : "0";
                var minutes2 = (rawTime2[2] != null) ? (hours2 * 60 + rawTime2[2].replace(":", "") * 1 + ":") : ((rawTime2[1] != null) ? rawTime2[1] : "00:");
                var seconds2 = (rawTime2[3] != null) ? (rawTime2[3]) : "00";
                var milliseconds2 = (rawTime2[4] != null) ? (rawTime2[4]) : ".000";
                var lrcTime2 = minutes2 + seconds2 + milliseconds2;
				console.log(minutes.replace(":","") * 60 + seconds * 1  - minutes2.replace(":","") * 60 - seconds2 * 1);
                if ( minutes.replace(":","") * 60 + seconds * 1  - minutes2.replace(":","") * 60 - seconds2 * 1  > 10) {
					console.log(minutes2 + (seconds2*1+10) + milliseconds2);
					if (minutes2 + (seconds2*1+10) + milliseconds2 == '00:10.000'){
                    lrcfile = lrcfile.concat(`[${minutes2 + (seconds2*1+10) + milliseconds2}]lrcInstrumental` + "\r\n");}
					else {lrcfile = lrcfile.concat(`[00:00.00]lrcInstrumental` + "\r\n");}
                };
			}
			console.log(lrcfile);
			ipcRenderer.send('LyricsHandlerNE',lrcfile);
		}
			
		} catch (e){
			ipcRenderer.send('LyricsMXMFailed','');
			console.error(e);}
		if (lrcfile!= "" && language_code != "disabled" && id != ''){
			console.log("no");
			var url2  = "https://apic-desktop.musixmatch.com/ws/1.1/crowd.track.translations.get?translation_fields_set=minimal&selected_language="+language_code+"&track_id="+id+"&comment_format=text&part=user&format=json&usertoken="+usertoken+"&app_id=web-desktop-app-v1.0&t="+revisedRandId();			
			var req2 = new XMLHttpRequest();  
			req2.overrideMimeType("application/json");
			req2.open('GET', url2, true);
			req2.setRequestHeader("authority", "apic-desktop.musixmatch.com");
			req2.onload  = function() {
			var jsonResponse2 = JSON.parse(this.responseText);
			console.log(jsonResponse2); 
			var status2 = jsonResponse2["message"]["header"]["status_code"] ;
		    if (status2 != 401){  
			var lyrics = jsonResponse2["message"]["body"]["translations_list"];
			console.log(lyrics);
			ipcRenderer.send('LyricsHandlerTranslation',lyrics);} else {
			var url  = "https://apic-desktop.musixmatch.com/ws/1.1/token.get?app_id=web-desktop-app-v1.0&t="+revisedRandId();
			var req3 = new XMLHttpRequest();  
			req3.overrideMimeType("application/json");
			req3.open('GET', url, true);
			req3.setRequestHeader("authority", "apic-desktop.musixmatch.com");
			req3.onload  = function() {	
			var jsonResponse = JSON.parse(this.responseText);
			var status2 = jsonResponse3["message"]["header"]["status_code"] ;
		    if (status2 == 200){
			token = jsonResponse3["message"]["body"]["user_token"] ?? '';
			if (token != "" && token != "UpgradeOnlyUpgradeOnlyUpgradeOnlyUpgradeOnly"){
				u(track, artist, lang);
			} else {
				
			}
		    }
			 else {}
	        }
		    req.send();
			}	
		    // window.close();
	    };
        req2.send();
	    } 
        } else {var url  = "https://apic-desktop.musixmatch.com/ws/1.1/token.get?app_id=web-desktop-app-v1.0&t="+revisedRandId();
			var req = new XMLHttpRequest();  
			req.overrideMimeType("application/json");
			req.open('GET', url, true);
			req.setRequestHeader("authority", "apic-desktop.musixmatch.com");
			req.onload  = function() {	
			var jsonResponse = JSON.parse(this.responseText);
			var status2 = jsonResponse["message"]["header"]["status_code"] ;
		    if (status2 == 200){
			token = jsonResponse["message"]["body"]["user_token"] ?? '';
			if (token != "" && token != "UpgradeOnlyUpgradeOnlyUpgradeOnlyUpgradeOnly"){
				u(track, artist, lang);
			}else {
				ipcRenderer.send('LyricsMXMFailed','');
			}
		    } else {ipcRenderer.send('LyricsMXMFailed','');}
	        }
		    req.send();}
		};
		req.send();
		}catch(e){
			console.log('borked');
			console.log(e);
			var url  = "https://apic-desktop.musixmatch.com/ws/1.1/token.get?app_id=web-desktop-app-v1.0&t="+revisedRandId();
			var req = new XMLHttpRequest();  
			req.overrideMimeType("application/json");
			req.open('GET', url, true);
			req.setRequestHeader("authority", "apic-desktop.musixmatch.com");
			req.onload  = function() {	
			var jsonResponse = JSON.parse(this.responseText);
			var status2 = jsonResponse["message"]["header"]["status_code"] ;
		    if (status2 == 200){
			token = jsonResponse["message"]["body"]["user_token"] ?? '';
			if (token != "" && token != "UpgradeOnlyUpgradeOnlyUpgradeOnlyUpgradeOnly"){
				u(track, artist, lang);
			} else {
				ipcRenderer.send('LyricsMXMFailed','');
			}
		    } else {ipcRenderer.send('LyricsMXMFailed','');}
	        }
		    req.send();
		//  window.close();		
		}


    } 
	ipcRenderer.on('mxmcors', function (event, track, artist, lang) {
		console.log("hello");
	   if (token!=null && token!= '' )
        {u(track, artist, lang);}
		else{
		var url  = "https://apic-desktop.musixmatch.com/ws/1.1/token.get?app_id=web-desktop-app-v1.0&t="+revisedRandId();
		var req = new XMLHttpRequest();  
        req.overrideMimeType("application/json");
        req.open('GET', url, true);
		req.setRequestHeader("authority", "apic-desktop.musixmatch.com");
        req.onload  = function() {	
        var jsonResponse = JSON.parse(this.responseText);
		var status2 = jsonResponse["message"]["header"]["status_code"] ;
		if (status2 == 200){
	    token = jsonResponse["message"]["body"]["user_token"] ?? '';
			if (token != "" && token != "UpgradeOnlyUpgradeOnlyUpgradeOnlyUpgradeOnly"){
				u(track, artist, lang);
			} else {
				ipcRenderer.send('LyricsMXMFailed','');
			}
		} else {ipcRenderer.send('LyricsMXMFailed','');}
	    }
		req.send();
		}
    });
	

	lrc.setLrc(text);
	</script>
</body>
</html>